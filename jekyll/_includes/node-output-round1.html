<!-- ========================== ROUND 1 ========================== -->
<div class="round-container" id="round1">
  <div style="height: 50px;"></div>
  <h2 style="text-align:center;">Round 1</h2>
  <hr/>

  <!-- TRAFFIC LIGHT SECTION (SMALLER) -->
  <div style="text-align: center;">
    <h4>Select state of the traffic light</h4>
  </div>
  <div style="text-align: center; margin-bottom: 20px;">
    <button id="colorRed" class="btn">Red</button>
    <button id="colorGreen" class="btn">Green</button>
    <br><br>
    <div class="traffic-light" id="trafficLight">
      <div class="light inactive-red" id="redCircle"></div>
      <div class="light inactive-green" id="greenCircle"></div>
    </div>
  </div>
  <hr/>

  <div style="text-align: center;">
    <h4>Output Node</h4>
  </div>

  <!-- INTERACTIVE TABLE (Round 1) -->
  <table class="interactive-table" id="interactiveTable">
    <thead>
      <tr>
        <th>Node</th>
        <th>Weight</th>
        <th>Input</th>
        <th>Numeric</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody>
      <!-- C1 -->
      <tr id="row1">
        <td>C1</td>
        <td id="weightCell1">20</td>
        <td>
          <select id="inputDropdown1" onchange="updateRow(1)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell1">
          <span class="cell-number-span" id="numericSpan1"></span>
        </td>
        <td id="valueCell1">
          <span class="cell-number-span" id="valueSpan1"></span>
        </td>
      </tr>

      <!-- C2 -->
      <tr id="row2">
        <td>C2</td>
        <td id="weightCell2">20</td>
        <td>
          <select id="inputDropdown2" onchange="updateRow(2)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell2">
          <span class="cell-number-span" id="numericSpan2"></span>
        </td>
        <td id="valueCell2">
          <span class="cell-number-span" id="valueSpan2"></span>
        </td>
      </tr>

      <!-- C3 -->
      <tr id="row3">
        <td>C3</td>
        <td id="weightCell3">20</td>
        <td>
          <select id="inputDropdown3" onchange="updateRow(3)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell3">
          <span class="cell-number-span" id="numericSpan3"></span>
        </td>
        <td id="valueCell3">
          <span class="cell-number-span" id="valueSpan3"></span>
        </td>
      </tr>

      <!-- C4 -->
      <tr id="row4">
        <td>C4</td>
        <td id="weightCell4">20</td>
        <td>
          <select id="inputDropdown4" onchange="updateRow(4)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell4">
          <span class="cell-number-span" id="numericSpan4"></span>
        </td>
        <td id="valueCell4">
          <span class="cell-number-span" id="valueSpan4"></span>
        </td>
      </tr>

      <!-- C5 -->
      <tr id="row5">
        <td>C5</td>
        <td id="weightCell5">20</td>
        <td>
          <select id="inputDropdown5" onchange="updateRow(5)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell5">
          <span class="cell-number-span" id="numericSpan5"></span>
        </td>
        <td id="valueCell5">
          <span class="cell-number-span" id="valueSpan5"></span>
        </td>
      </tr>

      <!-- C6 -->
      <tr id="row6">
        <td>C6</td>
        <td id="weightCell6">20</td>
        <td>
          <select id="inputDropdown6" onchange="updateRow(6)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell6">
          <span class="cell-number-span" id="numericSpan6"></span>
        </td>
        <td id="valueCell6">
          <span class="cell-number-span" id="valueSpan6"></span>
        </td>
      </tr>

      <!-- C7 -->
      <tr id="row7">
        <td>C7</td>
        <td id="weightCell7">20</td>
        <td>
          <select id="inputDropdown7" onchange="updateRow(7)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell7">
          <span class="cell-number-span" id="numericSpan7"></span>
        </td>
        <td id="valueCell7">
          <span class="cell-number-span" id="valueSpan7"></span>
        </td>
      </tr>

      <!-- C8 -->
      <tr id="row8">
        <td>C8</td>
        <td id="weightCell8">20</td>
        <td>
          <select id="inputDropdown8" onchange="updateRow(8)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell8">
          <span class="cell-number-span" id="numericSpan8"></span>
        </td>
        <td id="valueCell8">
          <span class="cell-number-span" id="valueSpan8"></span>
        </td>
      </tr>

      <!-- C9 -->
      <tr id="row9">
        <td>C9</td>
        <td id="weightCell9">20</td>
        <td>
          <select id="inputDropdown9" onchange="updateRow(9)">
            <option value="" disabled selected>Select</option>
            <option value="RED">RED</option>
            <option value="GREEN">GREEN</option>
          </select>
        </td>
        <td id="numericCell9">
          <span class="cell-number-span" id="numericSpan9"></span>
        </td>
        <td id="valueCell9">
          <span class="cell-number-span" id="valueSpan9"></span>
        </td>
      </tr>

    </tbody>
  </table>

  <br/>
  <hr/>
  <br/>

  <!-- DECISION TABLE (Round 1) -->
  <div style="text-align: center;">
    <h4>Sum and Output Node</h4>
  </div>
  <table class="decision-table" id="decisionTable">
    <thead>
      <tr>
        <th>Sum</th>
        <th>Output Node</th>
      </tr>
    </thead>
    <tbody>
      <!-- THIS ROW GETS COLORED RED OR GREEN BASED ON SUM -->
      <tr id="decisionRow">
        <td id="sumCell">---</td>
        <td id="outputCell">---</td>
      </tr>
    </tbody>
  </table>

  <!-- TRAFFIC LIGHT STATE (single row) -->
  <table class="decision-table" id="trafficLightStateTable">
    <tbody>
      <tr>
        <td id="trafficLightStateCell" style="font-weight:bold;">Traffic Light State: ---</td>
      </tr>
    </tbody>
  </table>

  <br/>
  <hr/>
  <br/>

  <!-- NETWORK STATUS TABLE (Round 1) -->
  <div style="text-align: center;">
    <h4>Summary</h4>
  </div>
  <table class="decision-table" id="networkStatusTable">
    <thead>
      <tr>
        <th>Round</th>
        <th>Network Status</th>
        <th>Sum</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1</td>
        <td id="networkStatusCell"></td>
        <td id="networkSumCell"></td>
      </tr>
    </tbody>
  </table>

  <!-- Bar Chart for Round 1 -->
  <div style="text-align:center; margin-top:30px; margin-bottom:30px;">
    <canvas id="round1BarChart" width="500" height="200" style="border:1px solid #000;">
      Your browser does not support Canvas.
    </canvas>
  </div>

  <br/><br/><br/>
  <div style="text-align:center; margin: 20px 0;">
    <button id="resetButton" onclick="location.reload()">Reset Table</button>
    <br/><br/>
    <select id="headerColorDropdown" onchange="updateHeaderColor()">
      <option value="" disabled selected>Change Heading Color</option>
      <option value="#f05f40">Orange</option>
      <option value="blue">Blue</option>
    </select>
  </div>

  <!-- Button to toggle/hide user input boxes for Round 1 -->
  <div style="text-align:center; margin: 20px;">
    <button id="toggleUserInputsBtn" onclick="toggleUserInputOverlays()">
      Hide User Boxes
    </button>
  </div>

  {% include copyright.html %}

  <!-- STYLES for coloring red/green rows -->
  <style>
    .row-red {
      background-color: red !important;
      color: #ffffff !important;
    }
    .row-green {
      background-color: green !important;
      color: #ffffff !important;
    }
    .cell-red {
      background-color: red !important;
      color: #ffffff !important;
    }
    .cell-green {
      background-color: green !important;
      color: #ffffff !important;
    }
  </style>

  <!-- SCRIPT FOR ROUND 1 -->
  <script>
    /***************************
     * Traffic Light Handling
     ***************************/
    const colorRedBtn   = document.getElementById('colorRed');
    const colorGreenBtn = document.getElementById('colorGreen');
    const redCircle     = document.getElementById('redCircle');
    const greenCircle   = document.getElementById('greenCircle');

    colorRedBtn.addEventListener('click', () => {
      colorRedBtn.classList.add('active');
      colorGreenBtn.classList.remove('active');
      redCircle.classList.remove('inactive-red');
      redCircle.classList.add('red');
      greenCircle.classList.remove('green');
      greenCircle.classList.add('inactive-green');

      updateNetworkStatusTable();
      updateRound2Weights();
    });

    colorGreenBtn.addEventListener('click', () => {
      colorGreenBtn.classList.add('active');
      colorRedBtn.classList.remove('active');
      greenCircle.classList.remove('inactive-green');
      greenCircle.classList.add('green');
      redCircle.classList.remove('red');
      redCircle.classList.add('inactive-red');

      updateNetworkStatusTable();
      updateRound2Weights();
    });

    function updateNetworkStatusTable() {
      const trafficLightStateCell = document.getElementById('trafficLightStateCell');
      let stateText = 'Traffic Light State: ---';

      if (colorRedBtn.classList.contains('active')) {
        stateText = 'Traffic Light State: RED';
        trafficLightStateCell.style.backgroundColor = 'red';
        trafficLightStateCell.style.color = 'white';
      } else if (colorGreenBtn.classList.contains('active')) {
        stateText = 'Traffic Light State: GREEN';
        trafficLightStateCell.style.backgroundColor = 'green';
        trafficLightStateCell.style.color = 'white';
      } else {
        trafficLightStateCell.style.backgroundColor = '';
        trafficLightStateCell.style.color = '';
      }
      trafficLightStateCell.textContent = stateText;

      // Compare final Output Node with the chosen traffic light state
      const decisionOutput = document.getElementById('outputCell').textContent;
      const currentLightState = stateText.replace('Traffic Light State: ', '').trim();

      let networkStatus;
      if (decisionOutput === 'UNDECIDED') {
        networkStatus = 'UNDECIDED';
      } else if (currentLightState === '---') {
        networkStatus = 'INCORRECT';
      } else if (decisionOutput === currentLightState) {
        networkStatus = 'CORRECT';
      } else {
        networkStatus = 'INCORRECT';
      }
      document.getElementById('networkStatusCell').textContent = networkStatus;

      const sumValue = document.getElementById('sumCell').textContent;
      document.getElementById('networkSumCell').textContent = sumValue;
    }

    /******************************
     * INTERACTIVE TABLE & DECISION
     ******************************/
    function updateRow(rowIdx) {
      const dropdown   = document.getElementById("inputDropdown" + rowIdx);
      const weightCell = document.getElementById("weightCell" + rowIdx);
      const numericSpan= document.getElementById("numericSpan" + rowIdx);
      const valueSpan  = document.getElementById("valueSpan" + rowIdx);

      // Remove previous color classes
      dropdown.parentElement.classList.remove('cell-red','cell-green');
      dropdown.classList.remove('select-red','select-green');

      const selection = dropdown.value;  // "RED"/"GREEN" or empty
      if (!selection) {
        numericSpan.textContent = "";
        valueSpan.textContent   = "";
        updateDecision();
        updateRound2Weights();
        return;
      }

     // Only changed these two lines:
      const parsedWeight = parseFloat(weightCell.textContent.trim());
      const weight = isNaN(parsedWeight) ? 20 : parsedWeight;

      // RED => -1, GREEN => +1
      const numericVal = (selection === "RED") ? -1 : 1;

      numericSpan.textContent = numericVal;
      valueSpan.textContent   = numericVal * weight;

      // Color input cell according to the selection
      if (selection === "RED") {
        dropdown.parentElement.classList.add('cell-red');
        dropdown.classList.add('select-red');
      } else {
        dropdown.parentElement.classList.add('cell-green');
        dropdown.classList.add('select-green');
      }

      // Update the sum & next round weights
      updateDecision();
      updateRound2Weights();
    }

    function updateDecision() {
      // Sum all the Value column cells from C1..C9
      let sum = 0;
      for (let i = 1; i <= 9; i++) {
        const valTxt = document.getElementById("valueSpan" + i).textContent.trim();
        sum += parseFloat(valTxt) || 0;
      }
      // Show sum
      document.getElementById("sumCell").textContent = sum;

      // Determine output node text
      let output;
      if (sum > 0) {
        output = "GREEN";
      } else if (sum < 0) {
        output = "RED";
      } else {
        output = "UNDECIDED";
      }
      document.getElementById("outputCell").textContent = output;

      // Color the entire row for sum+output
      const decisionRow = document.getElementById("decisionRow");
      decisionRow.classList.remove('row-red','row-green');
      if (sum > 0) {
        decisionRow.classList.add('row-green');
      } else if (sum < 0) {
        decisionRow.classList.add('row-red');
      }

      // Update "Network Status" table as well
      updateNetworkStatusTable();
    }

    function updateHeaderColor() {
      const newColor = document.getElementById('headerColorDropdown').value;
      const allHeaders = document.querySelectorAll(
        '#round1 .interactive-table th, #round1 .decision-table th'
      );
      allHeaders.forEach(th => {
        th.style.backgroundColor = newColor;
        th.style.color = '#ffffff';
      });
    }

    /*********************************************
     * 0 => -10 Fix: Update Round 2's Weights
     *********************************************/
     function updateRound2Weights() {
  let round1Light = null;
  if (colorRedBtn.classList.contains('active')) {
    round1Light = 'RED';
  } else if (colorGreenBtn.classList.contains('active')) {
    round1Light = 'GREEN';
  }

  for (let i = 1; i <= 9; i++) {
    const r2WeightCell = document.getElementById('weightCell2_' + i);
    if (!r2WeightCell) continue; // skip if Round 2 cell not found

    const r1WeightCell = document.getElementById('weightCell' + i);
    // OLD line we remove:
    // let finalR1Weight = parseFloat(r1WeightCell.textContent) || 20;

    // NEW lines:
    let parsedWeight = parseFloat(r1WeightCell.textContent.trim());
    let finalR1Weight = isNaN(parsedWeight) ? 20 : parsedWeight;

    // Compare Round1 input to Round1's traffic light:
    const round1Input = document.getElementById('inputDropdown' + i).value;
    if (round1Light && round1Input) {
      if (round1Input === round1Light) {
        finalR1Weight += 10;
      } else {
        finalR1Weight -= 10;
      }
    }

    // IMPORTANT: actually set Round 2's table cell
    r2WeightCell.textContent = finalR1Weight;
  }
}


    // Example: simple bar chart for Round 1
    function drawBarChartRound1() {
      const canvas = document.getElementById('round1BarChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      let weights = [];
      for (let i = 1; i <= 9; i++) {
        const cell = document.getElementById('weightCell' + i);
        let w = 0;
        if (cell && cell.textContent.trim() !== '') {
          w = parseFloat(cell.textContent.trim()) || 0;
        }
        weights.push(w);
      }

      // Clear the canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Basic min/max
      let minVal = Math.min(...weights);
      let maxVal = Math.max(...weights);
      if (minVal === maxVal) {
        minVal -= 10;
        maxVal += 10;
      }
      const padding = 5;
      minVal -= padding;
      maxVal += padding;

      const chartW = canvas.width;
      const chartH = canvas.height;
      const margin = 30;
      const usableW = chartW - margin * 2;
      const usableH = chartH - margin * 2;

      // Calculate where 0 would appear
      let zeroY;
      if (minVal < 0 && maxVal > 0) {
        zeroY = margin + (maxVal / (maxVal - minVal)) * usableH;
      } else if (maxVal < 0) {
        zeroY = margin + usableH;
      } else {
        zeroY = margin;
      }
      zeroY = Math.max(margin, Math.min(margin + usableH, zeroY));

      // X-axis
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(margin, zeroY);
      ctx.lineTo(margin + usableW, zeroY);
      ctx.stroke();

      // Y-axis
      ctx.beginPath();
      ctx.moveTo(margin, margin);
      ctx.lineTo(margin, margin + usableH);
      ctx.stroke();

      // Bars
      const barSpacing = usableW / 9;
      const barWidth   = 5;
      ctx.fillStyle    = '#f05f40';

      for (let i = 0; i < 9; i++) {
        const wVal = weights[i];
        const xCenter = margin + barSpacing * i + barSpacing / 2;
        const scale = usableH / (maxVal - minVal);
        const barHeight = Math.abs(wVal * scale);

        const barX = xCenter - barWidth/2;
        const barY = (wVal >= 0) ? zeroY - barHeight : zeroY;

        ctx.fillRect(barX, barY, barWidth, barHeight);

        // Label each bar as C1..C9
        ctx.fillStyle = 'black';
        ctx.font = '12px sans-serif';
        ctx.fillText('C' + (i+1), xCenter - 6, zeroY + 15);
        ctx.fillStyle = '#f05f40';
      }
    }

    // Re-draw chart periodically or whenever needed
    setInterval(drawBarChartRound1, 1000);
  </script>
</div> <!-- /round1 -->
